<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Wardrobe · Clothes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--pad:16px}
    body{font-family:system-ui,sans-serif; padding:var(--pad);}
    h3{margin:0 0 8px}
    a.back{display:inline-block; margin-top:8px}

    /* status */
    #status, #status2{font-size:12px; opacity:.85; min-height:1.2em; margin-top:6px}
    .ok{color:#0a7b32}
    .warn{color:#b06a00}
    .err{color:#b00020}

    /* mode switch */
    .mode-switch{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px}
    .mode-btn{
      display:grid; place-items:center; gap:6px;
      padding:12px; border-radius:12px; border:2px solid #ddd; background:#fff; cursor:pointer; font-weight:600;
    }
    .mode-btn.active{border-color:#4a90e2; background:#f1f7ff}

    /* blocks */
    .block{display:none}
    .block.active{display:block}

    /* camera */
    #cameraBox{margin-top:10px; border-radius:12px; overflow:hidden; background:#000; aspect-ratio:3/4; position:relative}
    #camera{width:100%; height:100%; object-fit:cover; display:none}
    #captured{display:none; width:100%; height:100%; object-fit:cover}
    .cam-overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      color:#fff; background:rgba(0,0,0,.35); font-weight:600; text-align:center; padding:16px;
    }
    .cam-overlay .stack{display:grid; gap:10px; justify-items:center}
    .cam-overlay button{
      padding:10px 14px; border-radius:10px; border:none; background:#4a90e2; color:#fff; font-weight:700; cursor:pointer;
    }

    .cam-controls{
      position:absolute; left:0; right:0; bottom:10px;
      display:grid; grid-template-columns:64px 1fr 64px; gap:10px; align-items:center; padding:0 12px; pointer-events:none;
    }
    .cam-controls .left, .cam-controls .right, .cam-controls .center{display:flex; justify-content:center; align-items:center; pointer-events:auto}
    .fab, .fab-secondary{border:none; border-radius:999px; color:#fff; cursor:pointer; display:grid; place-items:center}
    .fab{width:64px; height:64px; background:#4a90e2; box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .fab-secondary{width:44px; height:44px; background:rgba(0,0,0,.55)}
    .fab[disabled], .fab-secondary[disabled]{opacity:.5; cursor:default}
    .fab:active, .fab-secondary:active{transform:scale(.98)}
    .control-stack{display:grid; gap:4px; justify-items:center; color:#fff; font-size:11px}
    .control-stack .label{text-shadow:0 1px 2px rgba(0,0,0,.6)}

    /* preview (gallery mode) */
    #preview{margin-top:12px; max-width:100%; border-radius:12px; display:none}

    /* gallery (gallery mode) */
    #gallery{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:16px}
    .tile{position:relative; cursor:pointer; outline:2px solid transparent; outline-offset:2px; border-radius:12px}
    .tile.selected{outline-color:#6aa6ff}
    .tile img{width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:10px}
    .del{
      position:absolute; top:6px; right:6px; width:28px; height:28px; border:none; border-radius:999px;
      background:rgba(0,0,0,.55); color:#fff; font-weight:700; cursor:pointer
    }

    button,input{margin-top:12px; width:100%; padding:12px; border-radius:10px}
  </style>
</head>
<body>
<a class="back" href="/">← Back</a>
<h3>Upload clothes (max 3)</h3>

<!-- Mode switch -->
<div class="mode-switch">
  <button id="cameraModeBtn" class="mode-btn active" type="button">Camera</button>
  <button id="galleryModeBtn" class="mode-btn" type="button">Gallery</button>
</div>

<!-- Camera Block -->
<div id="cameraBlock" class="block active">
  <div id="cameraBox">
    <video id="camera" playsinline autoplay muted></video>
    <img id="captured" alt="Captured garment preview" />
    <!-- Start/Errors overlay (tap-to-start satisfies iOS gesture requirement) -->
    <div id="camOverlay" class="cam-overlay">
      <div class="stack">
        <div id="camOverlayMsg">Tap to enable camera</div>
        <button id="enableCamBtn" type="button">Enable camera</button>
      </div>
    </div>

    <div class="cam-controls">
      <div class="left">
        <div class="control-stack">
          <button id="flipBtn" class="fab-secondary" type="button" disabled>⇆</button>
          <div class="label">Flip</div>
        </div>
      </div>
      <div class="center">
        <button id="captureBtn" class="fab" type="button" disabled>●</button>
        <button id="uploadCamBtn" class="fab" type="button" style="display:none;">↑</button>
      </div>
      <div class="right">
        <div class="control-stack">
          <button id="retakeBtn" class="fab-secondary" type="button" disabled>⟳</button>
          <div class="label">Retake</div>
        </div>
      </div>
    </div>
  </div>
  <div id="status"></div>
</div>

<!-- Gallery Block -->
<div id="galleryBlock" class="block">
  <input id="files" type="file" accept="image/*" multiple />
  <button id="uploadBtn" type="button">Upload selected</button>
  <div id="status2"></div>

  <!-- Big preview of selected tile -->
  <img id="preview" alt="Preview" />

  <!-- User garments -->
  <div id="gallery"></div>
</div>

<script>
  // --- Config / Telegram ---
  const BACKEND_BASE = "https://newfoundland-administered-peoples-limiting.trycloudflare.com";
  const tg = window.Telegram?.WebApp || { initData: "" };
  tg?.ready?.();

  const $ = s => document.querySelector(s);
  const setStatus = (m, cls="", which=1) => {
    const el = which === 1 ? $("#status") : $("#status2");
    if (!el) return; el.className = cls; el.textContent = m || "";
  };
  const haptic = t => tg?.HapticFeedback?.notificationOccurred?.(t);

  // --- Helpers ---
  function uniqueName(ext=".jpg"){
    const rand = Math.random().toString(36).slice(2,8);
    return `garment_${Date.now()}_${rand}${ext}`;
  }
  function cssEscape(s){ return s.replace(/([ #;?%&,.+*~\\':"!^$[\\]()=>|/@])/g,'\\$1'); }

  // --- Backend calls ---
  async function garmentsList(limit=12){
    const initData=tg.initData||"";
    const res=await fetch(`${BACKEND_BASE}/garments/list`,{
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ initData, limit })
    });
    if(!res.ok) throw new Error("Failed to load garments");
    return res.json(); // [{key,url}]
  }
  async function garmentsPresign(file){
    const initData=tg.initData||"";
    const res=await fetch(`${BACKEND_BASE}/garments/presign-upload`,{
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ initData, filename:file.name, contentType:file.type })
    });
    if(!res.ok) throw new Error("Failed to presign garment");
    return res.json(); // { uploadUrl, key }
  }
  async function garmentsFinalize({key,sizeBytes,contentType}){
    const initData=tg.initData||"";
    const res=await fetch(`${BACKEND_BASE}/garments/finalize`,{
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ initData, key, sizeBytes, contentType })
    });
    if(!res.ok) throw new Error("Failed to finalize garment");
    return res.json(); // { previewUrl, duplicate, message }
  }
  async function garmentsDelete(key){
    const initData=tg.initData||"";
    const res=await fetch(`${BACKEND_BASE}/garments/delete`,{
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ initData, key })
    });
    if(!res.ok) throw new Error("Failed to delete garment");
    return res.json(); // { ok:true }
  }

  // --- Compression ---
  const MAX_BYTES = 1_500_000, MAX_DIM = 2048;

  async function fileToBitmap(file){
    if ('createImageBitmap' in window){
      const bmp = await createImageBitmap(file);
      return { img:bmp, w:bmp.width, h:bmp.height, close:()=>bmp.close() };
    }
    const url = URL.createObjectURL(file);
    const img = new Image();
    await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });
    URL.revokeObjectURL(url);
    return { img, w:img.naturalWidth, h:img.naturalHeight, close:()=>{} };
  }
  function drawToCanvas(src,w,h){
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    c.getContext('2d').drawImage(src,0,0,w,h);
    return c;
  }
  async function canvasToJpegUnder(c,max){
    let lo=0.5, hi=0.95, best=null;
    let blob=await new Promise(r=>c.toBlob(r,'image/jpeg',hi));
    if(blob.size<=max) return blob;
    for(let i=0;i<7;i++){
      const mid=(lo+hi)/2;
      blob=await new Promise(r=>c.toBlob(r,'image/jpeg',mid));
      if(blob.size<=max){ best=blob; hi=mid; } else lo=mid;
    }
    return best||blob;
  }
  async function compressImageToLimit(file, maxBytes=MAX_BYTES, maxDim=MAX_DIM){
    const {img,w,h,close}=await fileToBitmap(file);
    try{
      let tw=w, th=h;
      const scale = Math.max(w,h)>maxDim ? maxDim/Math.max(w,h) : 1;
      if (scale<1){ tw=Math.round(w*scale); th=Math.round(h*scale); }
      let canvas = drawToCanvas(img, tw, th);
      let jpeg = await canvasToJpegUnder(canvas, maxBytes);
      let attempts=0;
      while (jpeg.size>maxBytes && attempts<3 && Math.max(tw,th)>512){
        tw=Math.round(tw*0.85); th=Math.round(th*0.85);
        canvas = drawToCanvas(img, tw, th);
        jpeg = await canvasToJpegUnder(canvas, maxBytes);
        attempts++;
      }
      return new File([jpeg], uniqueName(".jpg"), { type:"image/jpeg" });
    } finally { close(); }
  }

  // --- Gallery render (only in Gallery mode) ---
  let selectedKey = null;

  async function loadGallery(renderGrid=true){
    try{
      const items = await garmentsList(12);
      const remaining = Math.max(0, 3 - items.length);

      if (renderGrid){
        renderGallery(items);
        const previewEl = $("#preview");
        if (items.length && (!previewEl.src || previewEl.src === location.href)) {
          setPreview(items[0].url, items[0].key);
        }
        setStatus(remaining ? `You can upload ${remaining} more item(s).` : `You've reached the limit (3).`, remaining? "" : "ok", 2);
      } else {
        // Camera mode: only show remaining count in camera status area
        setStatus(remaining ? `You can upload ${remaining} more item(s).` : `Limit reached (3).`, remaining? "" : "ok", 1);
      }
      return { items, remaining };
    }catch(e){
      // Never block UI; just show message in whichever is visible
      if ($("#galleryBlock").classList.contains("active")) {
        setStatus("Failed to load gallery", "err", 2);
      } else {
        setStatus("Failed to fetch limit; you can still try camera.", "warn", 1);
      }
      return { items:[], remaining:3 };
    }
  }

  function setPreview(url, key){
    const img = $("#preview");
    img.src = url;
    img.style.display = "block";
    selectedKey = key;
    document.querySelectorAll("#gallery .tile").forEach(t => t.classList.remove("selected"));
    const sel = document.querySelector(`.tile[data-key="${cssEscape(key)}"]`);
    if (sel) sel.classList.add("selected");
  }

  function renderGallery(items){
    const wrap=$("#gallery"); wrap.innerHTML="";
    items.forEach(it=>{
      const tile=document.createElement("div"); tile.className="tile"; tile.dataset.key=it.key;
      const img=document.createElement("img"); img.src=it.url; img.alt=it.key;
      img.addEventListener("click", ()=> setPreview(it.url, it.key));

      const del=document.createElement("button"); del.className="del"; del.textContent="×"; del.title="Delete";
      del.onclick=async e=>{
        e.stopPropagation();
        if(!confirm("Delete this clothing item?")) return;
        try{
          await garmentsDelete(it.key);
          await loadGallery(true);
          if (selectedKey === it.key){
            $("#preview").style.display="none";
            $("#preview").src="";
            selectedKey=null;
          }
          haptic("success");
        }catch(err){
          alert(err.message||"Delete failed"); haptic("error");
        }
      };

      tile.append(img, del);
      wrap.appendChild(tile);
    });

    // restore selection
    if (selectedKey){
      const sel = document.querySelector(`.tile[data-key="${cssEscape(selectedKey)}"]`);
      if (sel) sel.classList.add("selected");
    }
  }

  // --- Upload pipeline (shared) ---
  async function uploadGarmentFile(file, whichStatus=1){
    setStatus("Requesting presign…", "", whichStatus);
    const { uploadUrl, key } = await garmentsPresign(file);

    setStatus("Uploading…", "", whichStatus);
    const put = await fetch(uploadUrl, {
      method:"PUT",
      headers:{ "Content-Type": file.type, "x-amz-server-side-encryption":"AES256" },
      body:file
    });
    if (!put.ok) throw new Error("Upload failed");

    setStatus("Finalizing…", "", whichStatus);
    const { previewUrl, duplicate, message } =
            await garmentsFinalize({ key, sizeBytes:file.size, contentType:file.type });

    setStatus(message || "Uploaded", duplicate ? "warn" : "ok", whichStatus);
    tg.HapticFeedback?.notificationOccurred(duplicate ? "warning" : "success");
    return { previewUrl };
  }

  // --- Gallery mode: multi-upload respecting limit ---
  $("#uploadBtn").onclick = async ()=>{
    const files=[...$("#files").files];
    if(files.length===0){ alert("Pick files first"); return; }

    try{
      const { remaining } = await loadGallery(false); // don't render grid twice
      if (remaining<=0) { setStatus("You already have 3 items.", "err", 2); return; }

      const toUpload = files.slice(0, remaining);
      let lastPreview = null;

      for (const f of toUpload){
        setStatus(`Compressing ${f.name}…`, "", 2);
        const file = await compressImageToLimit(f);
        const { previewUrl } = await uploadGarmentFile(file, 2);
        if (previewUrl) lastPreview = previewUrl;
      }

      await loadGallery(true);
      if (lastPreview){
        setPreview(lastPreview, (new URL(lastPreview, location.href)).pathname || "");
      }
      haptic("success");
    }catch(e){
      console.error(e); setStatus(e.message||"Something went wrong","err",2); haptic("error");
    }
  };

  // --- Camera flow (gesture-gated) ---
  const video = $("#camera");
  const capturedImg = $("#captured");
  const overlay = $("#camOverlay");
  const overlayMsg = $("#camOverlayMsg");
  const enableCamBtn = $("#enableCamBtn");
  let stream = null;
  let facing = "user";
  let capturedBlob = null;

  function resetCameraUI(){
    if (capturedImg){ capturedImg.style.display="none"; capturedImg.src=""; }
    if (video){ video.style.display="block"; }
    $("#captureBtn").disabled=false;
    $("#retakeBtn").disabled=true;
    $("#uploadCamBtn").style.display="none";
    capturedBlob=null;
    setStatus("", "", 1);
  }
  function stopCamera(){
    if (stream){ for (const t of stream.getTracks()) t.stop(); stream=null; }
    video.srcObject = null;
    video.style.display = "none";
  }

  async function startCamera(){
    try{
      // Don’t await network here; just attempt camera immediately
      const gum = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:facing }, audio:false });
      stream = gum;
      video.srcObject = stream;
      await video.play().catch(()=>{});
      video.style.display = "block";

      overlay.style.display = "none";
      $("#flipBtn").disabled = false;
      $("#captureBtn").disabled = false;
      $("#retakeBtn").disabled = true;
    }catch(e){
      console.error(e);
      overlayMsg.textContent = "Camera unavailable. Check permissions and try again.";
      overlay.style.display = "flex";
      $("#flipBtn").disabled = true;
      $("#captureBtn").disabled = true;
      $("#retakeBtn").disabled = true;
      $("#uploadCamBtn").style.display = "none";
    }
  }

  enableCamBtn.addEventListener('click', async ()=>{ // user gesture -> iOS happy
    await startCamera();
    // also show remaining (non-blocking)
    loadGallery(false).catch(()=>{});
  });

  $("#flipBtn").onclick = async () => {
    facing = (facing === "user" ? { exact:"environment" } : "user");
    await startCamera();
  };

  $("#captureBtn").onclick = async () => {
    if (!video.videoWidth) return;
    const w = video.videoWidth, h = video.videoHeight;
    const c = document.createElement("canvas"); c.width=w; c.height=h;
    c.getContext("2d").drawImage(video,0,0,w,h);
    capturedBlob = await new Promise(r=>c.toBlob(r,"image/jpeg",0.95));

    capturedImg.src = URL.createObjectURL(capturedBlob);
    capturedImg.style.display = "block";
    video.style.display = "none";
    $("#retakeBtn").disabled = false;
    $("#captureBtn").disabled = true;
    $("#uploadCamBtn").style.display = "grid";
  };

  $("#retakeBtn").onclick = () => { resetCameraUI(); };

  $("#uploadCamBtn").onclick = async () => {
    if (!capturedBlob) return;
    try{
      setStatus("Compressing…", "", 1);
      const rawFile = new File([capturedBlob], uniqueName(".jpg"), { type:"image/jpeg" });
      const file = await compressImageToLimit(rawFile);
      await uploadGarmentFile(file, 1);
      // Return to live camera and refresh remaining silently
      resetCameraUI();
      await startCamera();
      loadGallery(false).catch(()=>{});
      haptic("success");
    }catch(e){
      console.error(e); setStatus(e.message||"Upload failed","err",1); haptic("error");
    }
  };

  // --- Mode switching (never blocked by async) ---
  const camBtn = $("#cameraModeBtn");
  const galBtn = $("#galleryModeBtn");
  const camBlock = $("#cameraBlock");
  const galBlock = $("#galleryBlock");

  function activateCameraMode(){
    camBtn.classList.add("active");
    galBtn.classList.remove("active");
    camBlock.classList.add("active");
    galBlock.classList.remove("active");
    // Don’t auto-start camera; require a tap to satisfy iOS
    stopCamera();
    overlayMsg.textContent = "Tap to enable camera";
    overlay.style.display = "flex";
    $("#flipBtn").disabled = true;
    $("#captureBtn").disabled = true;
    $("#retakeBtn").disabled = true;
    $("#uploadCamBtn").style.display = "none";
    setStatus("", "", 2); // clear gallery status
    // Optionally show remaining count (doesn't block UI)
    loadGallery(false).catch(()=>{});
  }

  async function activateGalleryMode(){
    galBtn.classList.add("active");
    camBtn.classList.remove("active");
    galBlock.classList.add("active");
    camBlock.classList.remove("active");
    stopCamera();
    setStatus("", "", 1); // clear camera status
    // Render gallery grid now
    await loadGallery(true).catch(()=>{});
  }

  camBtn.onclick = activateCameraMode;
  galBtn.onclick = activateGalleryMode;

  // Init: default to Camera UI but do NOT start camera until user taps
  document.addEventListener("DOMContentLoaded", () => {
    activateCameraMode();
  });

  window.addEventListener("pagehide", stopCamera);
  window.addEventListener("beforeunload", stopCamera);
</script>
</body>
</html>
