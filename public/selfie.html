<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Selfie Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --pad: 16px; }
    body { font-family: system-ui, sans-serif; padding: var(--pad); }
    h3 { margin: 0 0 8px; }
    #status { font-size: 12px; opacity: .75; margin-top: 6px; min-height: 1.2em; }
    #preview { margin-top: 16px; max-width: 100%; border-radius: 12px; display: block; }
    button, input { margin-top: 12px; width: 100%; padding: 12px; border-radius: 10px; }
    #gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 16px; }
    #gallery img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 10px; cursor: pointer; }
    .ok { color: #0a7b32; }
    .warn { color: #b06a00; }
    .err { color: #b00020; }
    .tile { position: relative; }
    .tile.selected img { outline: 3px solid rgba(0,0,0,.3); }
    .del {
      position: absolute; top: 6px; right: 6px;
      border: none; border-radius: 999px; width: 28px; height: 28px;
      font-weight: 700; background: rgba(0,0,0,.55); color: #fff;
      display: grid; place-items: center; cursor: pointer;
    }
    .del:active { transform: scale(.96); }
    .chooser { display: flex; gap: 12px; margin: 16px 0; }
    .chooser button { flex: 1; font-size: 18px; display: flex; align-items: center; justify-content: center; }
    #cameraBlock, #galleryBlock { display: none; }
    video { width: 100%; border-radius: 12px; margin-top: 12px; }
  </style>
</head>

<body>
  <a class="back" href="/">‚Üê Back</a>
  <h3>Choose upload method</h3>

  <div class="chooser">
    <button id="chooseCamera">üì∑ Camera</button>
    <button id="chooseGallery">üñºÔ∏è Gallery</button>
  </div>

  <!-- Camera block -->
  <div id="cameraBlock">
    <video id="cameraPreview" autoplay playsinline></video>
    <button id="snapBtn">Take Photo</button>
    <img id="camPhoto" style="display:none; margin-top:12px; border-radius:12px;" />
    <button id="uploadCamBtn" disabled>Upload Photo</button>
  </div>

  <!-- Gallery block -->
  <div id="galleryBlock">
    <input id="file" type="file" accept="image/*" />
    <button id="uploadBtn">Upload</button>
  </div>

  <div id="status"></div>
  <img id="preview" alt="Preview will appear here" />
  <div id="gallery"></div>

  <script>
    const BACKEND_BASE = "https://newfoundland-administered-peoples-limiting.trycloudflare.com";
    const tg = window.Telegram?.WebApp || { initData: "" };
    tg?.ready?.();

    const $ = s => document.querySelector(s);
    const setStatus = (msg, cls="") => { const el=$("#status"); el.className=cls; el.textContent=msg||""; };
    const haptic = t => tg?.HapticFeedback?.notificationOccurred?.(t);

    // ----- Unique filename helper -----
    function uniqueName(ext=".jpg") {
      const ts = Date.now();
      const rand = Math.floor(Math.random()*1e6);
      return `selfie_${ts}_${rand}${ext}`;
    }

    // ----- Backend helpers -----
    async function requestPresign(file) {
      const initData = tg.initData || "";
      const res = await fetch(`${BACKEND_BASE}/selfies/presign-upload`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData, filename: file.name, contentType: file.type })
      });
      if (!res.ok) throw new Error("Failed to presign");
      return res.json();
    }

    async function finalize({ key, sizeBytes, contentType }) {
      const initData = tg.initData || "";
      const res = await fetch(`${BACKEND_BASE}/selfies/finalize`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData, key, sizeBytes, contentType })
      });
      if (!res.ok) throw new Error("Failed to finalize");
      return res.json();
    }

    async function deleteSelfie(key) {
      const initData = tg.initData || "";
      const res = await fetch(`${BACKEND_BASE}/selfies/delete`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData, key })
      });
      if (!res.ok) throw new Error("Failed to delete");
      return res.json();
    }

    async function loadGallery(limit=24) {
      const initData = tg.initData || "";
      const res = await fetch(`${BACKEND_BASE}/selfies/list`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData, limit })
      });
      if (!res.ok) throw new Error("Failed to load gallery");
      const items = await res.json();
      renderGallery(items);

      if (!$("#preview").src && items.length) {
        $("#preview").src = items[0].url;
        document.querySelector("#gallery .tile")?.classList.add("selected");
      }
    }

    function renderGallery(items) {
      const wrap = $("#gallery");
      wrap.innerHTML = "";
      items.forEach(it => {
        const cell = document.createElement("div");
        cell.className = "tile";

        const img = document.createElement("img");
        img.src = it.url; img.alt = it.key;
        img.onclick = () => {
          $("#preview").src = it.url;
          document.querySelectorAll("#gallery .tile.selected").forEach(n=>n.classList.remove("selected"));
          cell.classList.add("selected");
        };

        const btn = document.createElement("button");
        btn.className = "del"; btn.textContent = "√ó";
        btn.onclick = async (e) => {
          e.stopPropagation();
          if (!confirm("Delete this photo?")) return;
          btn.disabled = true;
          try {
            await deleteSelfie(it.key);
            await loadGallery();
            haptic("success");
          } catch (err) {
            alert(err.message||"Delete failed"); haptic("error");
            btn.disabled=false;
          }
        };

        cell.appendChild(img);
        cell.appendChild(btn);
        wrap.appendChild(cell);
      });
    }

    // ----- Upload pipeline -----
    async function uploadFileThroughPipeline(file) {
      setStatus("Requesting presign‚Ä¶");
      const { uploadUrl, key } = await requestPresign(file);
      setStatus("Uploading‚Ä¶");
      const putRes = await fetch(uploadUrl, {
        method: "PUT",
        headers: { "Content-Type": file.type, "x-amz-server-side-encryption":"AES256" },
        body: file
      });
      if (!putRes.ok) throw new Error("Upload failed");
      setStatus("Finalizing‚Ä¶");
      const { previewUrl, message, duplicate } = await finalize({
        key, sizeBytes:file.size, contentType:file.type
      });
      $("#preview").src = previewUrl;
      await loadGallery();
      setStatus(message, duplicate?"warn":"ok");
      haptic(duplicate?"warning":"success");
    }

    // ----- Camera flow -----
    let stream, capturedBlob=null;
    $("#chooseCamera").onclick = async () => {
      $("#cameraBlock").style.display="block";
      $("#galleryBlock").style.display="none";
      if (!stream) {
        stream = await navigator.mediaDevices.getUserMedia({ video:true });
        $("#cameraPreview").srcObject = stream;
      }
    };

    $("#snapBtn").onclick = () => {
      const video = $("#cameraPreview");
      const canvas=document.createElement("canvas");
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
      canvas.getContext("2d").drawImage(video,0,0);
      canvas.toBlob(blob=>{
        capturedBlob=blob;
        $("#camPhoto").src=URL.createObjectURL(blob);
        $("#camPhoto").style.display="block";
        $("#uploadCamBtn").disabled=false;
      },"image/jpeg",0.9);
    };

    $("#uploadCamBtn").onclick = async () => {
      if (!capturedBlob) return;
      try {
        const named = new File([capturedBlob], uniqueName(".jpg"), { type:"image/jpeg" });
        await uploadFileThroughPipeline(named);
        $("#uploadCamBtn").disabled=true;
      } catch (e) {
        console.error(e); setStatus(e.message||"Something went wrong","err"); haptic("error");
      }
    };

    // ----- Gallery flow -----
    $("#chooseGallery").onclick = () => {
      $("#cameraBlock").style.display="none";
      $("#galleryBlock").style.display="block";
    };

    $("#uploadBtn").onclick = async () => {
      const original=$("#file").files[0];
      if (!original) { alert("Pick a file first"); return; }
      try {
        const named = new File([original], uniqueName(original.name.slice(original.name.lastIndexOf("."))), { type: original.type });
        await uploadFileThroughPipeline(named);
      } catch (e) {
        console.error(e); setStatus(e.message||"Something went wrong","err"); haptic("error");
      }
    };

    // Init
    document.addEventListener("DOMContentLoaded", ()=>{ loadGallery().catch(console.error); });
  </script>
</body>
</html>
